<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Data Visualization Forest</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
    font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
    background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);
    min-height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    padding:20px;
}
.container{width:100%;max-width:1200px;}
h1{color:#fff;text-align:center;margin-bottom:20px;text-shadow:2px 2px 4px rgba(0,0,0,.5);}
.controls{
    background:rgba(255,255,255,.1);
    backdrop-filter:blur(10px);
    padding:20px;
    border-radius:10px;
    margin-bottom:20px;
    color:white;
    display:flex;
    gap:20px;
    flex-wrap:wrap;
    align-items:center;
}
.control-group{display:flex;gap:10px;align-items:center;}
label{font-weight:600;}
input[type="file"],input[type="range"],select{
    padding:8px 12px;border:none;border-radius:5px;
    background:rgba(255,255,255,.2);color:white;cursor:pointer;
}
input[type="range"]{width:150px;}
input[type="file"]::file-selector-button{
    background:rgba(255,255,255,.3);color:white;border:none;
    padding:8px 16px;border-radius:5px;cursor:pointer;font-weight:600;
}
button{
    background:#4CAF50;color:white;border:none;
    padding:10px 20px;border-radius:5px;
    cursor:pointer;font-weight:600;
}
#canvas{
    width:100%;height:600px;border-radius:10px;
    box-shadow:0 10px 40px rgba(0,0,0,.3);
}
.info{color:white;text-align:center;margin-top:20px;font-size:14px;opacity:.9;}
.sample-data{
    background:rgba(255,255,255,.1);
    padding:15px;border-radius:5px;margin-top:15px;
    color:#ddd;font-size:13px;max-height:100px;overflow-y:auto;
}
</style>
</head>
<body>

<div class="container">
<h1>üå≤ Data Visualization Forest</h1>

<div class="controls">
    <div class="control-group">
        <label>üìÅ Load CSV:</label>
        <input type="file" id="fileInput" accept=".csv,.json">
    </div>

    <div class="control-group">
        <label>Max Height:</label>
        <input type="range" id="maxHeight" min="5" max="30" value="15">
        <span id="heightValue">15</span>
    </div>

    <div class="control-group">
        <label>Spacing:</label>
        <input type="range" id="spacing" min="1" max="10" value="3" step="0.5">
        <span id="spacingValue">3</span>
    </div>

    <button id="sampleBtn">üìä Load Sample Data</button>
    <button id="resetBtn">üîÑ Reset</button>
</div>

<canvas id="canvas"></canvas>

<div class="info">
üí° Left drag to rotate ‚Ä¢ Scroll to zoom
</div>

<div class="sample-data" id="sampleDisplay"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
const canvas = document.getElementById("canvas");
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);
scene.fog = new THREE.Fog(0x87CEEB,100,150);

const camera = new THREE.PerspectiveCamera(
    75,
    canvas.clientWidth / canvas.clientHeight,
    0.1,
    1000
);

camera.position.set(0,15,30);

const renderer = new THREE.WebGLRenderer({canvas,antialias:true});
renderer.setSize(canvas.clientWidth,canvas.clientHeight);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;   // FIXED

// lights
scene.add(new THREE.AmbientLight(0xffffff,0.6));

const dLight = new THREE.DirectionalLight(0xffffff,0.8);
dLight.position.set(20,30,20);
dLight.castShadow = true;
scene.add(dLight);

// ground
const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(200,200),
    new THREE.MeshLambertMaterial({color:0x2d5016})
);
ground.rotation.x = -Math.PI/2;
ground.receiveShadow = true;
scene.add(ground);

// grid
const grid = new THREE.GridHelper(100,100,0x444444,0x222222);
grid.position.y = 0.01;
scene.add(grid);

// simple rotate control
let mouseDown=false;
let lastX=0;

document.addEventListener("mousedown",e=>{
    mouseDown=true;
    lastX=e.clientX;
});
document.addEventListener("mouseup",()=>mouseDown=false);
document.addEventListener("mousemove",e=>{
    if(!mouseDown) return;
    const dx = e.clientX-lastX;
    lastX=e.clientX;
    camera.position.applyAxisAngle(
        new THREE.Vector3(0,1,0),
        dx*0.01
    );
    camera.lookAt(0,0,0);
});

canvas.addEventListener("wheel",e=>{
    e.preventDefault();
    const dir=camera.position.clone().normalize();
    const dist=camera.position.length();
    const nd=Math.max(5,Math.min(150,dist+e.deltaY*0.1));
    camera.position.copy(dir.multiplyScalar(nd));
});

// ---------------- data handling ----------------

let trees=[];
let currentData=[];   // FIX

let maxHeightValue=15;
let spacingValue=3;

function clearTrees(){
    trees.forEach(t=>scene.remove(t));
    trees=[];
}

function createTree(height,x,z,label){
    const g=new THREE.Group();

    const trunk=new THREE.Mesh(
        new THREE.CylinderGeometry(0.3,0.4,height*0.6,8),
        new THREE.MeshStandardMaterial({color:0x8B4513})
    );
    trunk.position.y=height*0.3;
    trunk.castShadow=true;
    g.add(trunk);

    const foliage=new THREE.Mesh(
        new THREE.ConeGeometry(height*0.5,height*0.7,16),
        new THREE.MeshStandardMaterial({color:0x228B22,roughness:.7})
    );
    foliage.position.y=height*0.75;
    foliage.castShadow=true;
    g.add(foliage);

    if(label){
        const c=document.createElement("canvas");
        c.width=256;c.height=64;
        const ctx=c.getContext("2d");
        ctx.fillStyle="white";
        ctx.font="bold 40px Arial";
        ctx.textAlign="center";
        ctx.textBaseline="middle";
        ctx.fillText(label,128,32);

        const tex=new THREE.CanvasTexture(c);
        const sp=new THREE.Sprite(new THREE.SpriteMaterial({map:tex}));
        sp.scale.set(2,.5,1);
        sp.position.y=height+1;
        g.add(sp);
    }

    g.position.set(x,0,z);
    return g;
}

function generateForest(data,maxHeight,spacing){
    clearTrees();

    if(!data.length) return;

    const maxVal=Math.max(...data.map(d=>d.value));
    const cols=Math.ceil(Math.sqrt(data.length));

    data.forEach((p,i)=>{
        const row=Math.floor(i/cols);
        const col=i%cols;

        const x=col*spacing-(cols*spacing)/2;
        const z=row*spacing-(cols*spacing)/2;
        const h=(p.value/maxVal)*maxHeight;

        const t=createTree(h,x,z,p.label);
        trees.push(t);
        scene.add(t);
    });

    camera.position.set(0,maxHeight*1.5,maxHeight*2); // FIX
    camera.lookAt(0,0,0);
}

// ---------------- parsing ----------------

function parseCSV(text){
    const lines=text.trim().split("\n");
    const headers=lines[0].split(",").map(h=>h.trim().toLowerCase());
    const data=[];

    for(let i=1;i<lines.length;i++){
        const vals=lines[i].split(",").map(v=>v.trim());
        const row={};
        headers.forEach((h,idx)=>row[h]=vals[idx]);

        const v=Number(row.value);
        if(!isNaN(v)){
            data.push({
                label:row.label||row.name||`Item ${i}`,
                value:v
            });
        }
    }
    return data;
}

function parseJSON(text){
    const json=JSON.parse(text);
    const arr=Array.isArray(json)?json:[json];

    return arr
        .filter(d=>d.value!==undefined)
        .map(d=>({
            label:d.label||d.name||"",
            value:Number(d.value)
        }))
        .filter(d=>!isNaN(d.value));
}

// ---------------- UI ----------------

document.getElementById("fileInput").addEventListener("change",e=>{
    const file=e.target.files[0];
    if(!file) return;

    const r=new FileReader();
    r.onload=ev=>{
        let data;
        if(file.name.endsWith(".csv")) data=parseCSV(ev.target.result);
        else data=parseJSON(ev.target.result);

        currentData=data;                     // FIX
        generateForest(currentData,maxHeightValue,spacingValue);
        displaySampleData(currentData);
    };
    r.readAsText(file);
});

document.getElementById("sampleBtn").addEventListener("click",()=>{
    const sampleData=[
        {label:"2000",value:369},
        {label:"2005",value:375},
        {label:"2010",value:380},
        {label:"2015",value:385},
        {label:"2020",value:390},
        {label:"2024",value:395},
        {label:"2025",value:397}
    ];
    currentData=sampleData;                  // FIX
    generateForest(currentData,maxHeightValue,spacingValue);
    displaySampleData(currentData);
});

document.getElementById("resetBtn").addEventListener("click",()=>{
    clearTrees();
    currentData=[];
    camera.position.set(0,15,30);
    camera.lookAt(0,0,0);
});

document.getElementById("maxHeight").addEventListener("input",e=>{
    maxHeightValue=Number(e.target.value);
    heightValue.textContent=maxHeightValue;
    if(currentData.length)
        generateForest(currentData,maxHeightValue,spacingValue);   // FIX
});

document.getElementById("spacing").addEventListener("input",e=>{
    spacingValue=Number(e.target.value);
    spacingValueSpan.textContent=spacingValue;
    if(currentData.length)
        generateForest(currentData,maxHeightValue,spacingValue);   // FIX
});

const spacingValueSpan=document.getElementById("spacingValue");
const heightValue=document.getElementById("heightValue");

function displaySampleData(data){
    sampleDisplay.innerHTML="<b>Loaded Data:</b><br>"+
        data.map(d=>`${d.label}: ${d.value}`).join(" | ");
}

// ---------------- render ----------------

function animate(){
    requestAnimationFrame(animate);
    renderer.render(scene,camera);
}
animate();

window.addEventListener("resize",()=>{
    const w=canvas.clientWidth;
    const h=canvas.clientHeight;
    camera.aspect=w/h;
    camera.updateProjectionMatrix();
    renderer.setSize(w,h);
});

document.getElementById("sampleBtn").click();
</script>
</body>
</html>
